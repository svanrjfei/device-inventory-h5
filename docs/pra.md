# H5 设备仪器盘点 — 需求文档（V1.0）

- 项目名称：设备仪器盘点（H5）
- 文档状态：初稿 V1.0（可迭代）
- 最后更新：2025-10-28

---

## 1. 背景与目标

- 背景：支持在移动端进行设备/仪器的扫码盘点、查询、浏览、快速标记缺失等操作，提升盘点效率与准确性。
- 目标：
  - 扫码定位设备并查看完整信息；
  - 支持按设备码/名称等关键词查询；
  - 提供设备台账总览、快速标记“是否缺失”、排序浏览；
  - 提供设备信息详情与编辑能力；
  - 兼顾多条匹配结果的处理与良好性能体验。

---

## 2. 范围与角色

- 范围：移动端 H5 界面（适配手机浏览器/WebView），对接后端数据库/API。
- 角色：
  - 盘点员：扫码、查询、浏览、标记缺失；
  - 管理员：除上述外，还可进入编辑页面修改设备信息。
- 范围外（本期不做）：
  - 批量导入导出、打印报表（可在后续里程碑规划）。

---

## 3. 信息架构与导航

- 底部固定 3 个 Tab（全局可见）：扫码｜查询｜设备台账。
- 详情页、编辑页为功能页面，从上述页面跳转进入，返回后回到来源页。

---

## 4. 页面与功能需求

下述各页均包含底部导航（除编辑页可选隐藏/半透明）。

### 4.1 扫码页

- 页面目标：最小化操作，一键进入扫码，获取设备信息。
- 核心功能：
  - 仅显示一个“扫码”主按钮；
  - 点击后调用摄像头进行扫码（二维码/条码），识别出设备码（或包含设备码的内容）。
  - 调用后端按设备码查询：
    - 若唯一匹配：跳转至【设备信息】页；
    - 若多条匹配：跳转至【查询结果】页展示列表；
    - 若无匹配：提示“未找到相关设备”，留在扫码页或引导至查询页。
- 权限与异常：首次需申请摄像头权限；拒绝则提供“前往设置”与“改用查询”的引导。
- 线框图：

```
┌──────────────────────────────┐
│            扫码              │ ← 顶部标题（可选）
├──────────────────────────────┤
│                              │
│        [  开始扫码  ]        │ ← 主按钮（仅此一项）
│                              │
│  提示：点击后将调用摄像头。  │
│  如权限被拒绝，请在设置中    │
│  允许“相机权限”，或前往查询页 │
│  以文本搜索。                │
└──────────────────────────────┘
[ 扫码 ]  [ 查询 ]  [ 设备台账 ]  ← 底部 Tab
```

- 扫码进行中（示意）：

```
┌──────────────────────────────┐
│            扫码中…           │
├──────────────────────────────┤
│  [ 摄像头取景框 ]            │
│  ■■■■■■■■■■■■■■■■■■■■       │
│  ■                      ■     │
│  ■     ▣ 识别区域 ▣     ■     │
│  ■                      ■     │
│  ■■■■■■■■■■■■■■■■■■■■       │
│  (对准二维码/条码即可识别)   │
│  [ 关闭 ] [ 闪光灯 ] [ 相册 ] │ (可选)
└──────────────────────────────┘
```

### 4.2 查询页

- 页面目标：通过关键词搜索设备，进入结果列表与详情。
- 核心功能：
  - 搜索框（支持设备码、名称、型号、保管人等字段）；
  - 输入回车或点击“搜索”按钮触发查询；
  - 跳转至【查询结果】页展示查询列表；
  - 可选项：搜索历史/清空历史。
- 线框图：

```
┌──────────────────────────────┐
│             查询             │
├──────────────────────────────┤
│ [ 设备码/名称/型号/保管人 🔍 ]│ ← 输入后回车/点搜索
│ (最近搜索: 1604761D, 减压阀)  │ ← 可选
│            [ 搜索 ]          │
└──────────────────────────────┘
[ 扫码 ]  [ 查询 ]  [ 设备台账 ]
```

### 4.3 查询结果页

- 页面目标：列表展示查询匹配结果，支持点击进入详情。
- 核心功能：
  - 卡片列表，展示名称、设备码、状态、位置、保管人、是否缺失（只读或可快捷修改，见下）；
  - 点击卡片进入【设备信息】页；
  - 当来自扫码页且多条匹配时，直接进入此页。
- 线框图：

```
┌──────────────────────────────┐
│           查询结果           │  (关键字："减压阀")
├──────────────────────────────┤
│ ▸ 一级减压阀    [在用][未缺失] │
│   编码: 1604761D  型号: SS316L │
│   位置: 茶山南...D101  保管: 彭旭锵 │
│   [缺失切换: ○]  更新时间: 2025-10-28 │
│ ─────────────────────────── │
│ ▸ 二级减压阀    [在用][缺失]   │
│   编码: 1604762X  型号: SS316L │
│   位置: ...                   │
│   [缺失切换: ●]  更新时间: ... │
└──────────────────────────────┘
[ 扫码 ]  [ 查询 ]  [ 设备台账 ]
```

- 备注：
  - 是否允许在查询结果列表中快捷修改“缺失”取决于权限与交互一致性（建议允许，与台账页一致）。

### 4.4 设备台账页

- 页面目标：总览所有设备，支持排序与“缺失”快捷修改。
- 核心功能：
  - 卡片列表展示数据库中全部设备（分页/增量加载）；
  - 顶部排序：按“最近更新/设备名称/状态/是否缺失”等；
  - 列表行内“缺失”快捷切换（有权限时生效，局部保存）；
  - 点击卡片进入【设备信息】页。
- 线框图：

```
┌──────────────────────────────┐
│           设备台账           │
├──────────────────────────────┤
│ 排序: [最近更新▼] [名称] [缺失] │
│ ─────────────────────────── │
│ ▸ 一级减压阀 1604761D       │
│   状态: 在用   位置: D101      │
│   保管: 彭旭锵  [缺失: ○]      │
│ ─────────────────────────── │
│ ▸ ...                        │
└──────────────────────────────┘
[ 扫码 ]  [ 查询 ]  [ 设备台账 ]
```

### 4.5 设备信息页

- 页面目标：展示设备完整信息，支持进入编辑或快捷修改“缺失”。
- 核心功能：
  - 显示完整字段（见数据模型）；
  - 动作：进入编辑页；切换“是否缺失”；
  - 来自扫码或查询、台账皆可到达；
  - 修改后更新“updatedAt”。
- 线框图：

```
┌──────────────────────────────┐
│           设备信息           │
├──────────────────────────────┤
│ 名称: 一级减压阀  [在用]      │
│ 编码: 1604761D   型号: SS316L │
│ 是否缺失: [○ 切换]            │
│ ─────────────────────────── │
│ 类型: 低值      单位: 台       │
│ 单价: 890.00    数量: 1        │
│ 金额: 890.00                  │
│ 部门: 化学与材料工程学院        │
│ 位置: [茶山南校区]...D101高温炉室 │
│ 保管: 彭旭锵                   │
│ 入库: 2016-12-07              │
│ 用途: 教学                    │
│ 出厂: null  发票: 33646449     │
│ 经费编号: null  经费来源: null  │
│ 备注: null                    │
│ 创建: 2025-10-28  更新: 2025-10-28 │
│ ─────────────────────────── │
│ [ 编辑信息 ]   [ 返回 ]        │
└──────────────────────────────┘
```

### 4.6 设备信息编辑页

- 页面目标：修改设备信息（管理员权限）。
- 核心功能：
  - 表单分组：基础信息、管理信息、财务信息、其他；
  - 支持局部更新（PATCH）；
  - 保存后回到【设备信息】并刷新。
- 线框图：

```
┌──────────────────────────────┐
│         编辑设备信息         │
├──────────────────────────────┤
│ 名称 [            ]          │
│ 编码 [            ] (只读?)   │
│ 型号 [            ]          │
│ 状态 [ 在用▼ ]               │
│ 是否缺失 [ ○/● ]             │
│ ...                          │
│ [ 取消 ]          [ 保存 ]    │
└──────────────────────────────┘
```

---

## 5. 业务流程（高层）

1) 扫码流程：
- 点击“开始扫码” → 调用摄像头识别设备码 → 请求后端：
  - 1 条匹配 → 打开设备信息页；
  - 多条匹配 → 打开查询结果页；
  - 0 条匹配 → toast 提示“未找到”，可留在扫码或跳转查询页。

2) 查询流程：
- 输入关键词 → 搜索 → 查询结果页 → 点卡片 → 设备信息页。

3) 台账浏览与标记：
- 进入设备台账 → 可切换排序 → 列表内快捷标记“缺失” → 局部保存 → 成功/失败反馈。

4) 编辑流程（管理员）：
- 设备信息页 → 编辑 → 修改字段 → 保存（PATCH）→ 返回详情并刷新。

---

## 6. 数据模型

来源示例（后端 JSON）：

```json
{
  "id": 761,
  "code": "1604761D",
  "name": "一级减压阀",
  "deviceType": "低值",
  "model": "SS316L",
  "unit": "台",
  "unitPrice": "890.00",
  "totalPrice": "890.00",
  "quantity": 1,
  "department": "化学与材料工程学院",
  "location": "[茶山南校区]南校区11号楼1层D101高温炉室",
  "keeper": "彭旭锵",
  "storageAt": "2016-12-07T00:00:00.000Z",
  "usage": "教学",
  "factoryNumber": "null",
  "invoiceNumber": "33646449",
  "fundingCode": "null",
  "funding": "null",
  "note": "null",
  "status": "在用",
  "missing": true,
  "createdAt": "2025-10-28T15:55:04.450Z",
  "updatedAt": "2025-10-28T15:55:04.450Z"
}
```

- 字段与说明：
  - id: number（主键）
  - code: string（设备码，不保证唯一，扫码可能匹配多条）
  - name: string（设备名称）
  - deviceType: string（设备类别/价值类型）
  - model: string（型号）
  - unit: string（计量单位）
  - unitPrice/totalPrice: string/number（金额，字符串或数值，前端统一转数值展示）
  - quantity: number（数量）
  - department: string（所属部门）
  - location: string（存放位置）
  - keeper: string（保管人）
  - storageAt: ISO string（入库日期）
  - usage: string（用途）
  - factoryNumber/invoiceNumber/fundingCode/funding/note: string|null
  - status: string（状态：在用/闲置/报废…）
  - missing: boolean（是否缺失，可快捷修改）
  - createdAt/updatedAt: ISO string（创建/更新时间）

- 前端展示与格式化：
  - 日期：显示为 yyyy-MM-dd；
  - 金额：显示为千分位与两位小数；
  - null/"null" 统一展示为“—”。

---

## 7. 接口设计（建议）

- 列表/查询：
  - GET `/api/devices?search=关键词&code=设备码&status=在用&missing=true|false&sort=updatedAt:desc&offset=0&limit=20`
  - 返回：`{ items: Device[], total: number }`

- 获取详情：
  - GET `/api/devices/:id`
  - 返回：`Device`

- 快捷修改“是否缺失”：
  - PATCH `/api/devices/:id`，Body：`{ missing: boolean }`
  - 返回：`Device`（含更新后的 updatedAt）

- 编辑设备信息（管理员）：
  - PATCH `/api/devices/:id`，Body：部分字段（如 name/model/status/...）

- 扫码解析：
  - 前端解析码值后优先使用 `code` 查询；
  - 若码值包含更多信息（如 `code+factoryNumber`），前后端约定解析规则并支持组合查询。

- 错误码与提示：
  - 404 未找到：友好提示并留在当前页；
  - 401/403 未授权：弹出权限不足提示；
  - 5xx 服务异常：提示“服务繁忙，请稍后重试”。

---

## 8. 交互与校验

- 快捷切换“缺失”采用乐观更新：
  - 切换后先本地生效 → 调用 PATCH；
  - 成功：保持状态；失败：回滚并 toast 错误。
- 编辑页表单校验：
  - 必填：name、status（可按后端规则扩展）；
  - 金额/数量：数字校验；
  - 日期：合法 ISO 或 yyyy-MM-dd。
- 权限：
  - 盘点员：可切换缺失；
  - 管理员：可编辑任意允许字段。

---

## 9. 性能与兼容

- 分页/增量加载：台账与查询结果采用 `limit/offset` 或 cursor 方案；
- 本地缓存：最近搜索、最近查看设备（可选）；
- 兼容性：现代移动浏览器（iOS Safari, Chrome/Android）；若摄像头 API 不可用，引导改用“查询页”。
- 扫码实现建议：`MediaDevices.getUserMedia` + `@zxing/browser` 或 `html5-qrcode`；支持闪光灯（受机型限制）。

---

## 10. 验收标准（关键条目）

- 底部 Tab：3 项固定，任意页可快速切换。
- 扫码：点击主按钮进入扫码；识别成功后根据匹配条数跳转到正确页面；权限被拒绝时有明确引导。
- 查询：输入关键词可查；结果列表可进入详情。
- 设备台账：可排序；可在列表内快速切换“缺失”（有权限）。
- 设备信息：字段展示完整；可进入编辑；可快捷切换“缺失”。
- 编辑：修改保存后刷新详情页；非法输入有校验提示。

---

## 11. 里程碑与扩展（建议）

- M1（本期）：底部导航、扫码、查询、查询结果、台账、详情、缺失快捷修改、编辑（基础字段）。
- M2：搜索历史、离线缓存与重试、更多排序与筛选、扫码相册识别。
- M3：批量导入导出、变更记录/审计、台账统计与报表。

---

## 12. 附：UI 线框总览（缩略）

```
[ 扫码 ]: 单按钮 → 扫码视图 → 详情/结果
[ 查询 ]: 搜索框 → 结果列表 → 详情
[ 台账 ]: 全量列表(排序/缺失快捷) → 详情
[ 详情 ]: 完整字段 + 编辑/缺失切换
[ 编辑 ]: 分组表单 + 保存/取消
```

> 注：以上为需求与交互基线，视觉规范（色板、字号、间距）与组件库选型（如 Ant Design Mobile/Vant）由设计与前端在实现期细化落地。

